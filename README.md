# Banking Client Communication Risk Rewriter (FINMA-style guardrails)

A FastAPI service that rewrites relationship-manager emails to reduce regulatory/compliance risk.
It classifies risk level, flags risky phrases, and injects a disclaimer when needed.

## What it does
Given:
- `email`: client message draft
- `audience`: e.g. `client`, `internal`, `compliance`
- `language`: default `en`

Returns:
- `rewritten_email`
- `risk_level` (`low` | `medium` | `high`)
- `flagged_phrases` (list)
- `disclaimer_added` (bool)
- `rationale` (short explanation)

## Live endpoints (Azure)
- Health: `GET /banking/health`
- Rewrite: `POST /banking/rewrite`
- OpenAPI: `/docs` and `/openapi.json`

Example:
- `https://pharma-email-assistant-mofr-gzcfdrhwgrdqgdgd.westeurope-01.azurewebsites.net/banking/health`

## API schema
### POST /banking/rewrite
Request body:
```json
{
  "email": "string",
  "audience": "string",
  "language": "en"
}
```

Response body:
```json
{
  "rewritten_email": "string",
  "risk_level": "medium",
  "flagged_phrases": ["string"],
  "disclaimer_added": true,
  "rationale": "string"
}
```

Quick test (curl)

Health:
```bash
curl -i "https://pharma-email-assistant-mofr-gzcfdrhwgrdqgdgd.westeurope-01.azurewebsites.net/banking/health"
```

Rewrite:
```bash
curl -i -X POST \
  "https://pharma-email-assistant-mofr-gzcfdrhwgrdqgdgd.westeurope-01.azurewebsites.net/banking/rewrite" \
  -H "Content-Type: application/json" \
  -d '{"email":"This product will give you excellent returns. You should invest now.","audience":"client","language":"en"}'
```

Local dev (Docker)

Build:
```bash
docker build -t pharma-email-assistant:local .
```

Run:
```bash
docker run --rm -p 8080:8080 \
  -e PORT=8080 \
  pharma-email-assistant:local
```

Test locally:
```bash
curl -i http://localhost:8080/banking/health
```

ARM Mac + Azure (AMD64) build

If you're on an ARM64 Mac, build an AMD64 image for Azure:
```bash
docker buildx create --use --name multiarch || docker buildx use multiarch
docker buildx build --platform linux/amd64 \
  -t mofasshara/pharma-email-assistant:banking-v2 \
  --push .
```

Risk classification rules (current)

Document what you‚Äôre flagging (examples):
- "guaranteed returns" -> high
- "will give you excellent returns" -> medium
- "you should invest now" -> medium/high

Notes

This is a demo for internal pilot-style workflows:
- human-in-the-loop friendly outputs
- audit-friendly rationale
- deterministic response schema

## Architecture (high level)
Client -> FastAPI (`/banking/rewrite`)
-> risk phrase scan + risk level assignment
-> disclaimer injection (if needed)
-> rewrite (rule-based rewrite v1)
-> structured JSON response + request id

## Azure App Service (container) settings
- Container type: Single container
- Registry: docker.io
- Image: mofasshara/pharma-email-assistant:banking-v2
- Port: 8080 (via PORT env var, if used)

# pharma-email-assistant2
AI-powered email rewriting assistant for medical/pharma use cases.
![Architecture Diagram](Untitled-2025-12-11-1423.png)

## Roadmap (Upcoming Weeks)
- Audience-specific rewriting prompts
- Compliance checker agent
- Add hallucination evaluation
- Add Docker deployment to Azure
## System Architecture
![architecture](docs/architecture.png)
## How logging works
- Every request to the `/rewrite` endpoint is recorded using Loguru.
- Logs include: input text, audience type, output email, and timestamp.
- Sensitive data (names, IDs, emails) should be anonymized before saving.
- Logs are stored in `logs/requests.jsonl` for later review.

## How to submit feedback
- After testing a rewritten email, you can rate or comment on its quality.
- Feedback is captured via the `/feedback` endpoint (to be added in Week 3).
- Each feedback entry links to the original request and output.
- This helps identify strong examples for fine-tuning and weak ones to improve.

## How to export dataset for evaluation
- Logged requests and feedback can be exported into a dataset file.
- Example: run a script that reads `logs/requests.jsonl` and outputs `dataset.csv`.
- The dataset includes: input, audience, output, feedback, and compliance tags.
- This dataset is then used for evaluation or fine-tuning in Month 3.

- # Pharma Email Assistant

A FastAPI-based application that rewrites pharma-related emails using OpenAI models.  
Deployed on Azure App Service with Docker.

---

## üöÄ Live Demo
- API Docs: https://pharma-email-assistant-mofr-gzcfdrhwgrdqgdgd.westeurope-01.azurewebsites.net/docs

---

## üèóÔ∏è Deployment Architecture
- **Frontend**: Swagger UI (auto-generated by FastAPI)
- **Backend**: FastAPI app (`src/api/main.py`)
- **Containerization**: Docker (Python 3.10-slim base image)
- **Hosting**: Azure App Service (Linux, B1 plan)
- **Registry**: Docker Hub (`mofasshara/pharma-email-assistant:latest`)

Flow:
1. Code ‚Üí Docker build ‚Üí Push to Docker Hub  
2. Azure App Service pulls image ‚Üí Runs container on port 80  
3. Public endpoint exposed via `azurewebsites.net`

---

## üîë Environment Variable Setup
Configured in **Azure Portal ‚Üí Settings ‚Üí Environment Variables**:

| Name            | Value Example           | Purpose                          |
|-----------------|-------------------------|----------------------------------|
| `OPENAI_API_KEY`| `sk-xxxxxx`             | Authenticates with OpenAI API    |
| `OPENAI_MODEL`  | `gpt-4o-mini`           | Defines model used for rewriting |

Secrets are **never hardcoded** in code ‚Äî they are injected at runtime by Azure.

---

## ‚òÅÔ∏è Azure App Service Explanation
- **App Service Plan**: B1 (Basic, Linux) ‚Äî beginner-friendly, cost-effective  
- **Continuous Deployment**: Pulls latest Docker image from Docker Hub  
- **Scaling**: Can scale vertically (larger plan) or horizontally (multiple instances)  
- **Monitoring**: Log Stream + Health Check for uptime visibility  
- **Security**: Environment variables stored securely, HTTPS enabled by default  

---

## üìå Next Steps
- Add `/health` endpoint for monitoring  
- Configure CI/CD with GitHub Actions ‚Üí auto-build & push Docker image  
- Document usage examples in README (sample payloads for `/rewrite`)  

## üñºÔ∏è Screenshots

### Azure Web App overview
"C:\Users\mofas\OneDrive\Desktop\AI engineer\docs.azure-app-overview.png"

### Swagger UI (live)
"C:\Users\mofas\OneDrive\Desktop\AI engineer\fastapi.UI.png"

## Live Deployments (Azure)

- Agent Orchestrator API (FastAPI + LangChain):  
  https://pharma-email-assistant-mofr-gzcfdrhwgrdqgdgd.westeurope-01.azurewebsites.net/docs

- Rewrite Service API (FastAPI):  
  https://pharma-email-rewrite-mofr-gph0dueeegetf9gr.westeurope-01.azurewebsites.net/docs

### Architecture
Agent Orchestrator routes requests and calls downstream tool services via environment-configured URLs.

## Production Architecture

- Agent API (FastAPI) deployed on Azure App Service
- Rewrite LLM service deployed as separate App Service
- Agent orchestrates calls to rewrite service via HTTP
- Hardened with:
  - HTTPS normalization
  - Request timeouts
  - Clear error propagation
- Observability:
  - Azure Log Stream
  - Application Insights (Search, Failures)
  - Availability monitoring
    
## Reliability & Monitoring

- Health endpoints for all services
- Azure Application Insights for:
  - Request tracing
  - Failure analysis
- Availability tests with alerting enabled
- Defensive networking (timeouts, retries, URL validation)
